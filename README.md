# Word 数据提取与填充工具

一个强大的工具，用于在 Word 文档和 Excel 电子表格之间进行智能数据交换。此工具采用现代化界面设计，使文档处理工作流程简单高效。

## 功能概述

### 功能一：从Word提取数据到Excel
- 自动识别Word模板中的占位符（例如 `{{姓名}}`, `{{年龄}}`, `{{序号}}`等）
- 智能匹配目标文档中的相应数据，支持模糊匹配和上下文识别
- 批量处理多个Word文档，提高数据收集效率
- 自动将提取的数据导出为结构化Excel表格，占位符名称作为列标题

### 功能二：从Excel填充数据到Word
- 根据Word模板中的占位符自动替换Excel表格中的对应数据
- 支持批量生成文档，既可合并到一个文件也可单独保存
- 灵活的文件命名规则，支持基于Excel数据的动态命名
- 保留原始文档格式和样式，确保生成文档的专业性

## 项目结构

```
FileTool/
├── main.py              # 程序入口
├── src/                 # 源代码目录
│   ├── core/            # 核心功能模块
│   │   ├── placeholder_parser.py  # 占位符解析器
│   │   ├── word_extractor.py      # Word数据提取功能
│   │   └── word_filler.py         # Word数据填充功能
│   ├── gui/             # 用户界面模块
│   │   ├── main_window.py         # 主窗口
│   │   ├── word_extractor_tab.py  # 数据提取选项卡
│   │   ├── word_filler_tab.py     # 数据填充选项卡
│   │   └── template_library.py    # 模板库管理
│   └── utils/           # 工具函数
├── examples/            # 示例文件
│   ├── 填充模板.docx
│   └── 数据提取.xlsx
└── logs/                # 日志文件目录
```

## 安装要求

### 系统要求
- Windows 10/11 或 macOS 10.14+
- Python 3.7 或更高版本
- 至少 4GB 内存和 100MB 磁盘空间

### 依赖包安装
```bash
pip install -r requirements.txt
```

主要依赖：
- PySide6（GUI界面）
- python-docx（Word文档处理）
- openpyxl（Excel数据处理）
- pandas（数据分析）
- loguru（日志管理）

## 使用实例

### 示例一：提取健康监护档案数据

假设您有多份健康监护档案文件（如examples目录中的CQ01和CQ02文件），需要从中提取姓名、年龄、体检结果等信息：

1. 创建一个包含所需提取字段的Word模板，使用占位符标记：
   ```
   姓名：{{姓名}}
   年龄：{{年龄}}
   性别：{{性别}}
   体检结果：{{体检结果}}
   ```

2. 启动程序并选择"数据提取"选项卡
3. 点击"选择模板"按钮并选择您创建的模板文件
4. 点击"选择源文件"按钮并选择目标档案文件（支持多选）
5. 设置输出Excel文件路径
6. 点击"开始提取"按钮

程序将自动从档案文件中提取数据并生成Excel表格：

| 姓名 | 年龄 | 性别 | 体检结果 |
|------|------|------|----------|
| 张三 | 28   | 男   | 合格     |
| 李四 | 35   | 女   | 合格     |

### 示例二：批量生成填充后的档案

1. 准备Excel数据文件，包含所有需要填充的信息：

| 姓名 | 年龄 | 性别 | 体检结果 | 体检日期   | 医生签名 |
|------|------|------|----------|------------|----------|
| 王五 | 42   | 男   | 需复查   | 2023-06-15 | 赵医生   |
| 赵六 | 31   | 女   | 合格     | 2023-06-15 | 赵医生   |

2. 准备Word模板文件，使用同样的占位符格式
3. 启动程序并选择"数据填充"选项卡
4. 点击"选择模板"按钮并选择模板文件
5. 点击"选择数据源"按钮并选择Excel数据文件
6. 设置输出目录
7. 选择输出模式（分开保存或合并为一个文件）
8. 设置文件命名规则，例如"{{姓名}}_健康档案"
9. 点击"开始填充"按钮

程序将为Excel中的每一行数据生成对应的Word文档。

## 进阶技巧

- **占位符语法**：除了基本的`{{字段名}}`格式外，还支持条件格式`{{字段名:条件表达式}}`
- **批处理优化**：处理大量文件时，可在设置中调整并行处理线程数
- **模板库**：频繁使用的模板可保存到模板库中，方便快速访问

## 故障排除

- 如果提取数据不准确，请检查模板中的占位符是否与目标文档中的上下文匹配
- 日志文件保存在logs目录中，可帮助诊断问题
- 如遇处理大文件时程序响应缓慢，可尝试在设置中调整内存使用限制

## 版本历史
- v1.2.0 - 添加模板库功能和批处理优化
- v1.1.0 - 改进占位符识别算法，提高匹配准确度
- v1.0.0 - 初始版本，包含基本的数据提取和填充功能

## 许可证
[MIT](LICENSE) 

## 深入分析与优化建议

本工具具备强大的基础功能，但在逻辑健robust性、性能和用户体验方面仍有提升空间。以下是一些分析和优化建议：

### A. 核心逻辑优化

1.  **增强数据提取的健壮性**:
    - **问题**: 当前的占位符值匹配可能依赖于简单的文本相对位置（如"标签: 值"），这在文档结构复杂时可能失效。
    - **建议**:
        - **表格结构化提取**: 优先利用Word中的表格作为结构化数据源。如果模板中占位符位于表格单元格内，应精确匹配源文件中对应表格的相应单元格数据。
        - **段落上下文分析**: 对于自由文本，不仅仅是查找"标签:",而是分析整个段落或相邻段落，以更可靠地定位数据。

2.  **安全的占位符表达式**:
    - **问题**: `{{字段名:条件表达式}}` 功能如果直接使用 `eval()` 函数执行，可能存在安全风险，允许在模板中注入恶意代码。
    - **建议**: 设计一个安全的微型表达式语言，仅支持必要的比较操作（如 `>`,`<`, `==`），或引入安全的表达式求值库。

3.  **提升填充时的格式保真度**:
    - **问题**: `python-docx` 中简单的文本替换 (`paragraph.text = ...`) 会清除段落内所有的精细格式（如局部加粗、不同颜色）。
    - **建议**: 在进行文本替换时，应在 `run` 级别上操作。遍历段落中的所有 `run`，找到包含占位符的 `run`，仅替换其文本内容，从而完整保留原始样式。

### B. 性能优化

1.  **优化并行处理机制**:
    - **问题**: `README` 中提到了并行处理，但Python的全局解释器锁（GIL）会限制 `threading` 在CPU密集型任务上的表现。
    - **建议**: 对于数据提取这类CPU密集型任务，推荐使用 `multiprocessing` 模块代替 `threading`，以绕过GIL，实现真正的多核并行计算，显著提升批量处理速度。

2.  **引入流式处理和内存管理**:
    - **问题**: 一次性加载大量或超大文件到内存中，可能导致程序内存溢出或响应缓慢。
    - **建议**:
        - **数据源流式读取**: 对于大型Excel文件，使用 `openpyxl` 的只读模式并逐行读取，而不是一次性用 `pandas` 加载整个文件。
        - **文档分批处理**: 将待处理的文档队列进行切分，按批次送入核心处理模块，避免内存占用峰值过高。

### C. 用户体验提升

1.  **确保UI的实时响应**:
    - **问题**: 任何耗时操作（如文件读写）都会阻塞GUI主线程，导致界面"假死"。
    - **建议**: 将所有文件处理逻辑放入一个独立的**工作线程**（在PySide6中为 `QThread`）。使用**信号与槽机制**将进度（如"已处理 5/100 个文件"）和结果安全地传递回主线程更新UI，保证界面的流畅响应。

2.  **增加"实时预览"功能**:
    - **问题**: 用户在开始批量处理前，无法确信模板和数据源的匹配是否正确。
    - **建议**: 提供一个"预览"按钮。用户选择模板和一个数据源（单个Word文档或Excel中的一行）后，点击预览即可立即看到单个填充/提取结果。这为用户提供了即时反馈，极大提升了可用性。

3.  **完善错误处理与报告**:
    - **问题**: 处理失败时，若缺乏清晰的错误提示，用户将难以定位问题。
    - **建议**: 创建一份详细的执行报告。任务结束后，清晰地告知用户："成功处理95个文件，5个文件失败。[查看日志]"。日志中应明确指出哪个文件在哪一步出错及其原因（例如："文件 `CQ02.docx` 处理失败，原因：在数据源 `data.xlsx` 中找不到占位符 `{{体检结果}}` 对应的数据"）。

### D. 未来功能扩展

1.  **支持图片占位符**:
    - **建议**: 增加替换图片的功能。可定义图片占位符语法，如 `{{img:照片}}`。用户在Excel中提供图片路径，程序读取后替换Word模板中的相应图片或占位符形状。

2.  **支持动态表格行生成**:
    - **建议**: 实现对表格内动态增删行的支持。例如，在模板中定义一个"模板行"，程序根据Excel中提供的列表数据（如订单中的多个商品），自动复制"模板行"并填充数据，以生成包含可变行数的表格。 